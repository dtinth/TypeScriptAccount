name: CI

on:
  push:
    branches: [main, develop, e2e]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.19

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run type-check

      - name: Lint
        run: bun run lint

      - name: Unit tests
        run: bun run test:unit

      - name: Build
        run: bun run build

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.19

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build

      - name: Start Grist
        run: docker compose -f e2e/docker-compose.yml up -d

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Run E2E tests
        run: bun run test:e2e
        env:
          CI: true

      - name: Percy
        if: ${{ always() && env.PERCY_TOKEN != '' }}
        run: bunx @percy/cli upload e2e-results/
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Upload E2E artifacts
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-results
          path: |
            test-results/
            e2e-results/
          retention-days: 7

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Publish test results to object storage
        continue-on-error: true
        run: |
          # Install Rclone
          curl https://rclone.org/install.sh | sudo bash

          # Upload playwright report
          rclone copy playwright-report/ publish:$PUBLISH_BUCKET/$PUBLISH_KEY/playwright-report/ --progress

          # Print report URL for CI logs
          REPORT_URL="$REPORT_URL_PREFIX/$PUBLISH_KEY/playwright-report/index.html"
          echo "ðŸ“Š Test report published: $REPORT_URL"

          # Generate preview URL and add to step summary
          echo "## ðŸ“Š Test Results Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **[View Test Report]($REPORT_URL)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Fallback: Download artifacts below if S3 link is unavailable" >> $GITHUB_STEP_SUMMARY
        env:
          PUBLISH_BUCKET: ghartifacts
          PUBLISH_KEY: ${{ github.repository }}/${{ github.run_id }}-${{ github.run_attempt }}
          REPORT_URL_PREFIX: https://ghartifacts.t3.storage.dev
          RCLONE_CONFIG_PUBLISH_TYPE: s3
          RCLONE_CONFIG_PUBLISH_PROVIDER: Other
          RCLONE_CONFIG_PUBLISH_REGION: auto
          RCLONE_CONFIG_PUBLISH_ACL: public-read
          RCLONE_CONFIG_PUBLISH_ENDPOINT: https://t3.storage.dev
          RCLONE_CONFIG_PUBLISH_ACCESS_KEY_ID: tid_cweGkGmDMMfHSUdYAEyGsRExuXHBTmAWVCWfa_XyogdcaaTlBo
          RCLONE_CONFIG_PUBLISH_SECRET_ACCESS_KEY: ${{ secrets.RCLONE_CONFIG_PUBLISH_SECRET_ACCESS_KEY }}
        if: always() && hashFiles('playwright-report/**/*') != ''
